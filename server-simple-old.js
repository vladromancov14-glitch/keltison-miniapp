const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://telegram.org"],
      scriptSrc: ["'self'", "https://telegram.org"],
      imgSrc: ["'self'", "data:", "https:", "blob:"],
      connectSrc: ["'self'", "https://api.telegram.org"],
      frameSrc: ["'self'", "https://telegram.org"]
    }
  }
}));

app.use(cors());
app.use(morgan('combined'));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Static files
app.use(express.static(path.join(__dirname, 'public')));

// Mock API endpoints
app.get('/api/categories', (req, res) => {
  res.json([
    { id: 1, name: '–¢–µ–ª–µ—Ñ–æ–Ω', icon: 'üì±', description: '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã –∏ –º–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã' },
    { id: 2, name: '–ù–æ—É—Ç–±—É–∫', icon: 'üíª', description: '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã' },
    { id: 3, name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞', icon: 'üß∫', description: '–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã' },
    { id: 4, name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫', icon: '‚ùÑÔ∏è', description: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏' },
    { id: 5, name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞', icon: 'üî•', description: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤—ã–µ –ø–µ—á–∏' },
    { id: 6, name: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞', icon: 'üçΩÔ∏è', description: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ –º–∞—à–∏–Ω—ã' },
    { id: 7, name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', icon: 'üì∫', description: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä—ã' }
  ]);
});

app.get('/api/brands', (req, res) => {
  const categoryId = req.query.category_id;
  
  let brands = [];
  
  if (categoryId === '1') { // –¢–µ–ª–µ—Ñ–æ–Ω—ã
    brands = [
      { id: 1, name: 'Apple', logo_url: 'https://logo.clearbit.com/apple.com', website: 'https://apple.com' },
      { id: 2, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 3, name: 'Xiaomi', logo_url: 'https://logo.clearbit.com/mi.com', website: 'https://mi.com' },
      { id: 4, name: 'Huawei', logo_url: 'https://logo.clearbit.com/huawei.com', website: 'https://huawei.com' }
    ];
  } else if (categoryId === '2') { // –ù–æ—É—Ç–±—É–∫–∏
    brands = [
      { id: 5, name: 'Apple', logo_url: 'https://logo.clearbit.com/apple.com', website: 'https://apple.com' },
      { id: 6, name: 'Lenovo', logo_url: 'https://logo.clearbit.com/lenovo.com', website: 'https://lenovo.com' },
      { id: 7, name: 'ASUS', logo_url: 'https://logo.clearbit.com/asus.com', website: 'https://asus.com' },
      { id: 8, name: 'HP', logo_url: 'https://logo.clearbit.com/hp.com', website: 'https://hp.com' }
    ];
  } else if (categoryId === '3') { // –°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã
    brands = [
      { id: 9, name: 'Bosch', logo_url: 'https://logo.clearbit.com/bosch.com', website: 'https://bosch.com' },
      { id: 10, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 11, name: 'LG', logo_url: 'https://logo.clearbit.com/lg.com', website: 'https://lg.com' },
      { id: 12, name: 'Whirlpool', logo_url: 'https://logo.clearbit.com/whirlpool.com', website: 'https://whirlpool.com' }
    ];
  } else if (categoryId === '4') { // –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏
    brands = [
      { id: 13, name: 'Bosch', logo_url: 'https://logo.clearbit.com/bosch.com', website: 'https://bosch.com' },
      { id: 14, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 15, name: 'LG', logo_url: 'https://logo.clearbit.com/lg.com', website: 'https://lg.com' },
      { id: 16, name: 'Whirlpool', logo_url: 'https://logo.clearbit.com/whirlpool.com', website: 'https://whirlpool.com' }
    ];
  } else if (categoryId === '5') { // –ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∏
    brands = [
      { id: 17, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 18, name: 'LG', logo_url: 'https://logo.clearbit.com/lg.com', website: 'https://lg.com' },
      { id: 19, name: 'Panasonic', logo_url: 'https://logo.clearbit.com/panasonic.com', website: 'https://panasonic.com' },
      { id: 20, name: 'Sharp', logo_url: 'https://logo.clearbit.com/sharp.com', website: 'https://sharp.com' }
    ];
  } else if (categoryId === '6') { // –ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ –º–∞—à–∏–Ω—ã
    brands = [
      { id: 21, name: 'Bosch', logo_url: 'https://logo.clearbit.com/bosch.com', website: 'https://bosch.com' },
      { id: 22, name: 'Siemens', logo_url: 'https://logo.clearbit.com/siemens.com', website: 'https://siemens.com' },
      { id: 23, name: 'Electrolux', logo_url: 'https://logo.clearbit.com/electrolux.com', website: 'https://electrolux.com' },
      { id: 24, name: 'Candy', logo_url: 'https://logo.clearbit.com/candy.com', website: 'https://candy.com' }
    ];
  } else if (categoryId === '7') { // –¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    brands = [
      { id: 25, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 26, name: 'LG', logo_url: 'https://logo.clearbit.com/lg.com', website: 'https://lg.com' },
      { id: 27, name: 'Sony', logo_url: 'https://logo.clearbit.com/sony.com', website: 'https://sony.com' },
      { id: 28, name: 'TCL', logo_url: 'https://logo.clearbit.com/tcl.com', website: 'https://tcl.com' }
    ];
  } else {
    // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    brands = [
      { id: 1, name: 'Apple', logo_url: 'https://logo.clearbit.com/apple.com', website: 'https://apple.com' },
      { id: 2, name: 'Samsung', logo_url: 'https://logo.clearbit.com/samsung.com', website: 'https://samsung.com' },
      { id: 3, name: 'Xiaomi', logo_url: 'https://logo.clearbit.com/mi.com', website: 'https://mi.com' },
      { id: 4, name: 'Huawei', logo_url: 'https://logo.clearbit.com/huawei.com', website: 'https://huawei.com' }
    ];
  }
  
  res.json(brands);
});

app.get('/api/models', (req, res) => {
  const brandId = req.query.brand_id;
  const categoryId = req.query.category_id;
  
  let models = [];
  
  // –¢–µ–ª–µ—Ñ–æ–Ω—ã
  if (brandId === '1') { // Apple —Ç–µ–ª–µ—Ñ–æ–Ω—ã
    models = [
      { id: 1, brand_id: 1, category_id: 1, name: 'iPhone 14', description: '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω Apple', brand_name: 'Apple', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 2, brand_id: 1, category_id: 1, name: 'iPhone 13', description: '–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ iPhone', brand_name: 'Apple', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 3, brand_id: 1, category_id: 1, name: 'iPhone SE', description: '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π iPhone', brand_name: 'Apple', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' }
    ];
  } else if (brandId === '2') { // Samsung —Ç–µ–ª–µ—Ñ–æ–Ω—ã
    models = [
      { id: 4, brand_id: 2, category_id: 1, name: 'Galaxy S23', description: '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω Samsung', brand_name: 'Samsung', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 5, brand_id: 2, category_id: 1, name: 'Galaxy A54', description: '–°—Ä–µ–¥–Ω–∏–π –∫–ª–∞—Å—Å Samsung', brand_name: 'Samsung', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 6, brand_id: 2, category_id: 1, name: 'Galaxy Note', description: 'Samsung —Å S-Pen', brand_name: 'Samsung', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' }
    ];
  } else if (brandId === '3') { // Xiaomi —Ç–µ–ª–µ—Ñ–æ–Ω—ã
    models = [
      { id: 7, brand_id: 3, category_id: 1, name: 'Redmi Note 12', description: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω Xiaomi', brand_name: 'Xiaomi', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 8, brand_id: 3, category_id: 1, name: 'Mi 13', description: '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π Xiaomi', brand_name: 'Xiaomi', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' }
    ];
  } else if (brandId === '4') { // Huawei —Ç–µ–ª–µ—Ñ–æ–Ω—ã
    models = [
      { id: 9, brand_id: 4, category_id: 1, name: 'P60 Pro', description: '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π Huawei', brand_name: 'Huawei', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' },
      { id: 10, brand_id: 4, category_id: 1, name: 'Nova 11', description: '–°—Ä–µ–¥–Ω–∏–π –∫–ª–∞—Å—Å Huawei', brand_name: 'Huawei', category_name: '–¢–µ–ª–µ—Ñ–æ–Ω' }
    ];
  }
  // –ù–æ—É—Ç–±—É–∫–∏
  else if (brandId === '5') { // Apple –Ω–æ—É—Ç–±—É–∫–∏
    models = [
      { id: 11, brand_id: 5, category_id: 2, name: 'MacBook Pro 14"', description: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–æ—É—Ç–±—É–∫ Apple', brand_name: 'Apple', category_name: '–ù–æ—É—Ç–±—É–∫' },
      { id: 12, brand_id: 5, category_id: 2, name: 'MacBook Air M2', description: '–õ–µ–≥–∫–∏–π –Ω–æ—É—Ç–±—É–∫ Apple', brand_name: 'Apple', category_name: '–ù–æ—É—Ç–±—É–∫' }
    ];
  } else if (brandId === '6') { // Lenovo –Ω–æ—É—Ç–±—É–∫–∏
    models = [
      { id: 13, brand_id: 6, category_id: 2, name: 'ThinkPad X1', description: '–ë–∏–∑–Ω–µ—Å –Ω–æ—É—Ç–±—É–∫ Lenovo', brand_name: 'Lenovo', category_name: '–ù–æ—É—Ç–±—É–∫' },
      { id: 14, brand_id: 6, category_id: 2, name: 'IdeaPad Gaming', description: '–ò–≥—Ä–æ–≤–æ–π –Ω–æ—É—Ç–±—É–∫ Lenovo', brand_name: 'Lenovo', category_name: '–ù–æ—É—Ç–±—É–∫' }
    ];
  } else if (brandId === '7') { // ASUS –Ω–æ—É—Ç–±—É–∫–∏
    models = [
      { id: 15, brand_id: 7, category_id: 2, name: 'ROG Strix', description: '–ò–≥—Ä–æ–≤–æ–π –Ω–æ—É—Ç–±—É–∫ ASUS', brand_name: 'ASUS', category_name: '–ù–æ—É—Ç–±—É–∫' },
      { id: 16, brand_id: 7, category_id: 2, name: 'ZenBook Pro', description: '–ü—Ä–µ–º–∏—É–º –Ω–æ—É—Ç–±—É–∫ ASUS', brand_name: 'ASUS', category_name: '–ù–æ—É—Ç–±—É–∫' }
    ];
  } else if (brandId === '8') { // HP –Ω–æ—É—Ç–±—É–∫–∏
    models = [
      { id: 17, brand_id: 8, category_id: 2, name: 'Pavilion Gaming', description: '–ò–≥—Ä–æ–≤–æ–π –Ω–æ—É—Ç–±—É–∫ HP', brand_name: 'HP', category_name: '–ù–æ—É—Ç–±—É–∫' },
      { id: 18, brand_id: 8, category_id: 2, name: 'EliteBook', description: '–ë–∏–∑–Ω–µ—Å –Ω–æ—É—Ç–±—É–∫ HP', brand_name: 'HP', category_name: '–ù–æ—É—Ç–±—É–∫' }
    ];
  }
  // –ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
  else if (brandId === '9') { // Bosch –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
    models = [
      { id: 19, brand_id: 9, category_id: 3, name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ WAU', description: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Bosch', brand_name: 'Bosch', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 20, brand_id: 9, category_id: 3, name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ KGN', description: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ Bosch', brand_name: 'Bosch', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 21, brand_id: 9, category_id: 3, name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ HMT', description: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ Bosch', brand_name: 'Bosch', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 22, brand_id: 9, category_id: 3, name: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ SMS', description: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ Bosch', brand_name: 'Bosch', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' }
    ];
  } else if (brandId === '10') { // Samsung –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
    models = [
      { id: 23, brand_id: 10, category_id: 3, name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ WW', description: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Samsung', brand_name: 'Samsung', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 24, brand_id: 10, category_id: 3, name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ RF', description: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ Samsung', brand_name: 'Samsung', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 25, brand_id: 10, category_id: 3, name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ MW', description: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ Samsung', brand_name: 'Samsung', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 26, brand_id: 10, category_id: 3, name: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ DW', description: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ Samsung', brand_name: 'Samsung', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' }
    ];
  } else if (brandId === '11') { // LG –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
    models = [
      { id: 27, brand_id: 11, category_id: 3, name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ F', description: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ LG', brand_name: 'LG', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 28, brand_id: 11, category_id: 3, name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ GSL', description: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ LG', brand_name: 'LG', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 29, brand_id: 11, category_id: 3, name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ MS', description: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ LG', brand_name: 'LG', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 30, brand_id: 11, category_id: 3, name: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ DF', description: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ LG', brand_name: 'LG', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' }
    ];
  } else if (brandId === '12') { // Whirlpool –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
    models = [
      { id: 31, brand_id: 12, category_id: 3, name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ W', description: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Whirlpool', brand_name: 'Whirlpool', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 32, brand_id: 12, category_id: 3, name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ W', description: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ Whirlpool', brand_name: 'Whirlpool', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 33, brand_id: 12, category_id: 3, name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ W', description: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞ Whirlpool', brand_name: 'Whirlpool', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
      { id: 34, brand_id: 12, category_id: 3, name: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ W', description: '–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ Whirlpool', brand_name: 'Whirlpool', category_name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' }
    ];
  }
  // –¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã
  else if (brandId === '13') { // Samsung —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    models = [
      { id: 35, brand_id: 13, category_id: 4, name: 'QLED Q80C', description: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä Samsung QLED', brand_name: 'Samsung', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' },
      { id: 36, brand_id: 13, category_id: 4, name: 'Neo QLED QN90C', description: '–ü—Ä–µ–º–∏—É–º —Ç–µ–ª–µ–≤–∏–∑–æ—Ä Samsung', brand_name: 'Samsung', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' }
    ];
  } else if (brandId === '14') { // LG —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    models = [
      { id: 37, brand_id: 14, category_id: 4, name: 'OLED C3', description: 'OLED —Ç–µ–ª–µ–≤–∏–∑–æ—Ä LG', brand_name: 'LG', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' },
      { id: 38, brand_id: 14, category_id: 4, name: 'NanoCell NANO', description: 'NanoCell —Ç–µ–ª–µ–≤–∏–∑–æ—Ä LG', brand_name: 'LG', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' }
    ];
  } else if (brandId === '15') { // Sony —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    models = [
      { id: 39, brand_id: 15, category_id: 4, name: 'BRAVIA XR A95K', description: 'OLED —Ç–µ–ª–µ–≤–∏–∑–æ—Ä Sony', brand_name: 'Sony', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' },
      { id: 40, brand_id: 15, category_id: 4, name: 'BRAVIA XR X95K', description: 'LED —Ç–µ–ª–µ–≤–∏–∑–æ—Ä Sony', brand_name: 'Sony', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' }
    ];
  } else if (brandId === '16') { // TCL —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    models = [
      { id: 41, brand_id: 16, category_id: 4, name: 'C735 QLED', description: 'QLED —Ç–µ–ª–µ–≤–∏–∑–æ—Ä TCL', brand_name: 'TCL', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' },
      { id: 42, brand_id: 16, category_id: 4, name: 'P635 LED', description: 'LED —Ç–µ–ª–µ–≤–∏–∑–æ—Ä TCL', brand_name: 'TCL', category_name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä' }
    ];
  } else {
    // –ï—Å–ª–∏ –±—Ä–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    models = [];
  }
  
  res.json(models);
});

app.get('/api/problems', (req, res) => {
  res.json([
    { id: 1, category_id: 1, name: '–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è', description: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∫–∏', severity: 'high' },
    { id: 2, category_id: 1, name: '–†–∞–∑–±–∏—Ç —ç–∫—Ä–∞–Ω', description: '–¢—Ä–µ—Å–Ω—É–ª –∏–ª–∏ —Ä–∞–∑–±–∏—Ç –¥–∏—Å–ø–ª–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', severity: 'medium' },
    { id: 3, category_id: 2, name: '–ù–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è', description: '–ù–æ—É—Ç–±—É–∫ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –ø–∏—Ç–∞–Ω–∏—è', severity: 'critical' }
  ]);
});

app.get('/api/instructions', (req, res) => {
  res.json([
    {
      id: 1,
      model_id: 1,
      problem_id: 1,
      title: '–ó–∞–º–µ–Ω–∞ —Ä–∞–∑—ä–µ–º–∞ Lightning',
      description: '–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–º–µ–Ω–µ —Ä–∞–∑—ä–µ–º–∞ –∑–∞—Ä—è–¥–∫–∏ iPhone 14',
      difficulty: 'hard',
      estimated_time: '1-2 —á–∞—Å–∞',
      tools_required: ['–û—Ç–≤–µ—Ä—Ç–∫–∞ P2 Pentalobe', '–ü—Ä–∏—Å–æ—Å–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞'],
      parts_required: ['–†–∞–∑—ä–µ–º Lightning', '–ö–ª–µ–π –¥–ª—è —ç–∫—Ä–∞–Ω–∞'],
      cost_estimate: 1500.00,
      is_pro_pretent: false,
      model_name: 'iPhone 14',
      brand_name: 'Apple',
      problem_name: '–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è'
    }
  ]);
});

// Get specific instruction by ID
app.get('/api/instructions/:id', (req, res) => {
  const instructionId = req.params.id;
  
  const instruction = {
    id: parseInt(instructionId),
    model_id: 1,
    problem_id: 1,
    title: '–ó–∞–º–µ–Ω–∞ —Ä–∞–∑—ä–µ–º–∞ Lightning',
    description: '–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–º–µ–Ω–µ —Ä–∞–∑—ä–µ–º–∞ –∑–∞—Ä—è–¥–∫–∏ iPhone 14',
    difficulty: 'hard',
    estimated_time: '1-2 —á–∞—Å–∞',
    tools_required: ['–û—Ç–≤–µ—Ä—Ç–∫–∞ P2 Pentalobe', '–ü—Ä–∏—Å–æ—Å–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞'],
    parts_required: ['–†–∞–∑—ä–µ–º Lightning', '–ö–ª–µ–π –¥–ª—è —ç–∫—Ä–∞–Ω–∞'],
    cost_estimate: 1500.00,
    is_pro_pretent: false,
    model_name: 'iPhone 14',
    brand_name: 'Apple',
    problem_name: '–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è',
    steps: [
      {
        step: 1,
        title: '–û—Ç–∫–ª—é—á–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ',
        description: '–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–∏—Ç–µ iPhone –∏ –æ—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ –∫–∞–±–µ–ª–∏',
        image_url: null
      },
      {
        step: 2,
        title: '–°–Ω–∏–º–∏—Ç–µ –≤–∏–Ω—Ç—ã',
        description: '–û—Ç–∫—Ä—É—Ç–∏—Ç–µ –¥–≤–∞ –≤–∏–Ω—Ç–∞ Pentalobe –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
        image_url: null
      },
      {
        step: 3,
        title: '–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—Ä–ø—É—Å',
        description: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏—Å–æ—Å–∫—É –¥–ª—è —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—å –¥–∏—Å–ø–ª–µ–π',
        image_url: null
      },
      {
        step: 4,
        title: '–ó–∞–º–µ–Ω–∏—Ç–µ —Ä–∞–∑—ä–µ–º',
        description: '–û—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Ä–∞–∑—ä–µ–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π',
        image_url: null
      },
      {
        step: 5,
        title: '–°–æ–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ',
        description: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–∏—Å–ø–ª–µ–π –æ–±—Ä–∞—Ç–Ω–æ –∏ –∑–∞–∫—Ä—É—Ç–∏—Ç–µ –≤–∏–Ω—Ç—ã',
        image_url: null
      }
    ]
  };
  
  res.json(instruction);
});

app.get('/api/partners', (req, res) => {
  res.json([
    { id: 1, name: 'iFixit', website: 'https://ru.ifixit.com', logo_url: 'https://logo.clearbit.com/ifixit.com', description: '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', is_active: true },
    { id: 2, name: 'AliExpress', website: 'https://aliexpress.ru', logo_url: 'https://logo.clearbit.com/aliexpress.com', description: '–®–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –∑–∞–ø—á–∞—Å—Ç–µ–π', is_active: true }
  ]);
});

// Mock WebApp init
app.post('/api/auth/webapp-init', (req, res) => {
  res.json({
    success: true,
    token: 'mock-jwt-token-' + Date.now(),
    user: {
      id: 1,
      telegram_id: 123456789,
      username: 'testuser',
      first_name: 'Test',
      last_name: 'User',
      is_admin: false,
      is_premium: false
    },
    subscription: {
      plan: 'free',
      status: 'active'
    }
  });
});

// Mock AI chat
app.post('/api/assistant/chat', (req, res) => {
  const { message } = req.body;
  
  let response = 'üß∞ –ú–∞—Å—Ç–µ—Ä –ö–Å–õ–¢–ò–°–û–ù:\n\n';
  
  if (message.toLowerCase().includes('–Ω–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è')) {
    response += '–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞—Ä—è–¥–∫–æ–π:\n\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–±–µ–ª—å –∏ –∞–¥–∞–ø—Ç–µ—Ä\n‚Ä¢ –û—á–∏—Å—Ç–∏—Ç–µ —Ä–∞–∑—ä–µ–º –æ—Ç –ø—ã–ª–∏\n‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∫–∞–±–µ–ª—å\n‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ\n\nüëâ [–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]';
  } else if (message.toLowerCase().includes('—Ä–∞–∑–±–∏—Ç')) {
    response += '–ü—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∞:\n\n‚Ä¢ –û–±–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ø–ª–µ–Ω–∫—É\n‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–º–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω\n‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ü–µ–Ω—Ç—Ä\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—é\n\nüëâ [–ù–∞–π—Ç–∏ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ü–µ–Ω—Ç—Ä]';
  } else if (message.toLowerCase().includes('–º–µ–¥–ª–µ–Ω–Ω–æ')) {
    response += '–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:\n\n‚Ä¢ –ó–∞–∫—Ä–æ–π—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n‚Ä¢ –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π\n‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ\n‚Ä¢ –û—Å–≤–æ–±–æ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ\n\nüëâ [–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]';
  } else {
    response += '–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –∏ —è –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ!\n\n–ú–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å:\n‚Ä¢ –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, –Ω–æ—É—Ç–±—É–∫)\n‚Ä¢ –ú–∞—Ä–∫—É –∏ –º–æ–¥–µ–ª—å\n‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\n\n–ü—Ä–∏–º–µ—Ä: "–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è iPhone 14"';
  }
  
  res.json({
    session_id: 'mock-session-' + Date.now(),
    response: response,
    metadata: {
      local_ai: true,
      instructions_found: 1,
      has_pro_access: false
    },
    suggestions: [
      '–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ',
      '–†–∞–∑–±–∏—Ç —ç–∫—Ä–∞–Ω',
      '–ú–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç',
      '–ù–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è'
    ]
  });
});

// Mock admin login
app.post('/api/admin/login', (req, res) => {
  const { username, password } = req.body;
  
  if (username === process.env.ADMIN_USERNAME && password === process.env.ADMIN_PASSWORD) {
    res.json({
      success: true,
      token: 'admin-token-' + Date.now(),
      admin: {
        id: 1,
        username: username,
        is_admin: true
      }
    });
  } else {
    res.status(401).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    version: '1.0.0',
    environment: process.env.NODE_ENV || 'development',
    mode: 'simple (no database)'
  });
});

// Main page
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Admin page
app.get('/admin', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'admin.html'));
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({ 
    error: 'Internal Server Error',
    message: process.env.NODE_ENV === 'development' ? err.message : 'Something went wrong'
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Not Found' });
});

// Start server
app.listen(PORT, () => {
  console.log(`üöÄ K–ÅLTISON Mini App server running on port ${PORT}`);
  console.log(`üì± WebApp URL: ${process.env.WEBAPP_URL || `http://localhost:${PORT}`}`);
  console.log(`üîß Admin Panel: ${process.env.WEBAPP_URL || `http://localhost:${PORT}`}/admin`);
  console.log(`‚ù§Ô∏è Health Check: ${process.env.WEBAPP_URL || `http://localhost:${PORT}`}/health`);
  console.log(`üéØ Mode: Simple (mock data, no database)`);
  
  if (process.env.NODE_ENV === 'production') {
    console.log('üåê Production mode enabled');
  } else {
    console.log('üîß Development mode enabled');
  }
});
