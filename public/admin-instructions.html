<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏</title>
    <link rel="stylesheet" href="styles.css?v=3">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .admin-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .btn-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .instruction-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }
        
        .instruction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .instruction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .instruction-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .instruction-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .meta-badge {
            background: #f8f9fa;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .instruction-description {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .instruction-tools {
            margin-bottom: 15px;
        }
        
        .tools-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .tools-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tool-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .instruction-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .media-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        
        .media-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .media-info {
            text-align: center;
        }
        
        .media-info small {
            color: #666;
            font-size: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }
        
        .steps-section {
            margin-top: 20px;
        }
        
        .step-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e1e5e9;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-number {
            font-weight: 600;
            color: #667eea;
        }
        
        .btn-remove-step {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-add-step {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .auth-section {
            text-align: center;
            padding: 40px;
        }
        
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div id="authSection" class="auth-section">
            <div class="auth-form">
                <h2 class="auth-title">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <div class="form-group">
                    <label class="form-label">–¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                    <input type="password" id="adminToken" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
                </div>
                <button id="loginBtn" class="btn-admin">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="adminInterface" class="hidden">
            <div class="admin-header">
                <h1>üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏</h1>
                <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —É–¥–∞–ª—è–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–µ–º–æ–Ω—Ç—É</p>
            </div>

            <div class="admin-controls">
                <button id="addBtn" class="btn-admin">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é</button>
                <button id="logoutBtn" class="btn-admin btn-danger">üö™ –í—ã–π—Ç–∏</button>
            </div>

            <div id="instructionsList" class="instructions-grid">
                <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="instructionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é</h2>
                <span class="close" id="closeModalBtn">&times;</span>
            </div>

            <form id="instructionForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</label>
                    <input type="text" id="instructionTitle" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="instructionDescription" class="form-input form-textarea" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="instructionCategory" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–ë—Ä–µ–Ω–¥</label>
                    <select id="instructionBrand" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                    <select id="instructionModel" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–ü—Ä–æ–±–ª–µ–º–∞</label>
                    <select id="instructionProblem" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É</option>
                        <option value="1">–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è</option>
                        <option value="2">–ó–∞–º–µ–Ω–∞ –¥–∏—Å–ø–ª–µ—è</option>
                        <option value="3">–ó–∞–º–µ–Ω–∞ –∫–Ω–æ–ø–æ–∫ –≥—Ä–æ–º–∫–æ—Å—Ç–∏</option>
                        <option value="4">–ó–∞–º–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∞</option>
                        <option value="5">–ó–∞–º–µ–Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞</option>
                        <option value="6">–ü—Ä–æ—à–∏–≤–∫–∞</option>
                        <option value="7">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                    <select id="instructionDifficulty" class="form-select" required>
                        <option value="easy">–õ–µ–≥–∫–æ</option>
                        <option value="medium">–°—Ä–µ–¥–Ω–µ</option>
                        <option value="hard">–°–ª–æ–∂–Ω–æ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="instructionTime" class="form-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 1-2 —á–∞—Å–∞" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–µ–π (—Ä—É–±.)</label>
                    <input type="number" id="instructionCost" class="form-input" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="instructionTools" class="form-input" placeholder="–û—Ç–≤–µ—Ä—Ç–∫–∞ P2, –ü—Ä–∏—Å–æ—Å–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞">
                </div>

                <div class="form-group">
                    <label class="form-label">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="instructionParts" class="form-input" placeholder="–î–∏—Å–ø–ª–µ–π iPhone 5, –ö–ª–µ–π –¥–ª—è —ç–∫—Ä–∞–Ω–∞">
                </div>

                <div class="form-group">
                    <label class="form-label">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)</label>
                    <input type="file" id="instructionMedia" class="form-input" multiple accept="image/*,video/*">
                    <small style="color: #666; font-size: 12px;">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–∞–π–ª–æ–≤ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: jpg, png, gif; –≤–∏–¥–µ–æ: mp4, avi, mov, webm)</small>
                </div>

                <div class="steps-section">
                    <h3>–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
                    <div id="stepsContainer">
                        <!-- –®–∞–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                    <button type="button" id="addStepBtn" class="btn-add-step">‚ûï –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
                </div>

                <div style="margin-top: 30px; text-align: right;">
                    <button type="button" id="cancelBtn" class="btn-admin" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-admin">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        let authToken = null;
        let editingInstructionId = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function authenticate() {
            console.log('authenticate() –≤—ã–∑–≤–∞–Ω–∞');
            const token = document.getElementById('adminToken').value;
            console.log('–¢–æ–∫–µ–Ω:', token);
            
            const authSection = document.getElementById('authSection');
            const adminInterface = document.getElementById('adminInterface');
            console.log('authSection:', authSection);
            console.log('adminInterface:', adminInterface);
            
            if (token === 'admin-token') {
                console.log('–¢–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è');
                authToken = token;
                authSection.classList.add('hidden');
                adminInterface.classList.remove('hidden');
                loadInstructions();
            } else {
                console.log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω');
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            }
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            authToken = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('adminInterface').classList.add('hidden');
            document.getElementById('adminToken').value = '';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        async function loadInstructions() {
            try {
                const response = await fetch('/api/admin/instructions', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const instructions = await response.json();
                    displayInstructions(instructions);
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π');
                }
            } catch (error) {
                console.error('Error loading instructions:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function displayInstructions(instructions) {
            const container = document.getElementById('instructionsList');
            container.innerHTML = '';

            instructions.forEach(instruction => {
                const card = document.createElement('div');
                card.className = 'instruction-card';
                card.innerHTML = `
                    <div class="instruction-header">
                        <h3 class="instruction-title">${instruction.title}</h3>
                    </div>
                    <div class="instruction-meta">
                        <span class="meta-badge">${instruction.model_name}</span>
                        <span class="meta-badge">${instruction.problem_name}</span>
                        <span class="meta-badge">${instruction.difficulty}</span>
                        <span class="meta-badge">${instruction.estimated_time}</span>
                    </div>
                    <div class="instruction-description">${instruction.description}</div>
                    <div class="instruction-tools">
                        <div class="tools-label">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</div>
                        <div class="tools-list">
                            ${(instruction.tools_required || instruction.tools || []).map(tool => `<span class="tool-tag">${tool}</span>`).join('')}
                        </div>
                    </div>
                    ${instruction.media && instruction.media.length > 0 ? `
                    <div class="instruction-media">
                        <div class="media-label">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã:</div>
                        <div class="media-list">
                            ${instruction.media.map(media => `
                                <div class="media-item">
                                    ${media.mimetype.startsWith('image/') ? 
                                        `<img src="${media.url}" alt="${media.originalname}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">` :
                                        `<video controls style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                                            <source src="${media.url}" type="${media.mimetype}">
                                        </video>`
                                    }
                                    <div class="media-info">
                                        <small>${media.originalname}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    <div class="instruction-actions">
                        <button data-instruction-id="${instruction.id}" class="btn-admin btn-small edit-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button data-instruction-id="${instruction.id}" class="btn-admin btn-small btn-danger delete-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            container.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const instructionId = this.getAttribute('data-instruction-id');
                    editInstruction(instructionId);
                });
            });
            
            container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const instructionId = this.getAttribute('data-instruction-id');
                    deleteInstruction(instructionId);
                });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function loadCategoriesForAdmin() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();
                
                const select = document.getElementById('instructionCategory');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function loadBrandsForAdmin() {
            const categoryId = document.getElementById('instructionCategory').value;
            if (!categoryId) {
                document.getElementById('instructionBrand').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>';
                document.getElementById('instructionModel').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>';
                return;
            }

            try {
                const response = await fetch(`/api/brands?category_id=${categoryId}`);
                const brands = await response.json();
                
                const select = document.getElementById('instructionBrand');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>';
                
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.id;
                    option.textContent = brand.name;
                    select.appendChild(option);
                });

                // –û—á–∏—â–∞–µ–º –º–æ–¥–µ–ª–∏
                document.getElementById('instructionModel').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>';
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function loadModelsForAdmin() {
            const categoryId = document.getElementById('instructionCategory').value;
            const brandId = document.getElementById('instructionBrand').value;
            
            if (!categoryId || !brandId) {
                document.getElementById('instructionModel').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>';
                return;
            }

            try {
                const response = await fetch(`/api/models?brand_id=${brandId}&category_id=${categoryId}`);
                const models = await response.json();
                
                const select = document.getElementById('instructionModel');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>';
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        function showAddModal() {
            editingInstructionId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é';
            document.getElementById('instructionForm').reset();
            document.getElementById('stepsContainer').innerHTML = '';
            addStep(); // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            loadCategoriesForAdmin();
            
            document.getElementById('instructionModal').style.display = 'block';
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        function editInstruction(id) {
            editingInstructionId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é';
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('instructionModal').style.display = 'block';
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        async function deleteInstruction(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é?')) {
                try {
                    const response = await fetch(`/api/admin/instructions/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        alert('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
                        loadInstructions();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
                    }
                } catch (error) {
                    console.error('Error deleting instruction:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
                }
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞
        function addStep() {
            const container = document.getElementById('stepsContainer');
            const stepNumber = container.children.length + 1;
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-item';
            stepDiv.innerHTML = `
                <div class="step-header">
                    <span class="step-number">–®–∞–≥ ${stepNumber}</span>
                    <button type="button" class="btn-remove-step remove-step-btn">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞</label>
                    <input type="text" class="form-input step-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-input form-textarea step-description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="text" class="form-input step-time" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5 –º–∏–Ω—É—Ç" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ –∫ —à–∞–≥—É</label>
                    <input type="file" class="form-input step-photo" accept="image/*" multiple>
                    <small style="color: #666; font-size: 12px;">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ —à–∞–≥–∞</small>
                </div>
            `;
            container.appendChild(stepDiv);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–≥–∞
            const removeBtn = stepDiv.querySelector('.remove-step-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    removeStep(this);
                });
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–≥–∞
        function removeStep(button) {
            button.closest('.step-item').remove();
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —à–∞–≥–æ–≤
            const steps = document.querySelectorAll('.step-number');
            steps.forEach((step, index) => {
                step.textContent = `–®–∞–≥ ${index + 1}`;
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            document.getElementById('instructionModal').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('instructionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
            formData.append('model_id', document.getElementById('instructionModel').value);
            formData.append('problem_id', document.getElementById('instructionProblem').value);
            formData.append('category_id', document.getElementById('instructionCategory').value);
            formData.append('title', document.getElementById('instructionTitle').value);
            formData.append('description', document.getElementById('instructionDescription').value);
            formData.append('difficulty', document.getElementById('instructionDifficulty').value);
            formData.append('estimated_time', document.getElementById('instructionTime').value);
            formData.append('cost_estimate', document.getElementById('instructionCost').value);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∑–∞–ø—á–∞—Å—Ç–∏
            const tools = document.getElementById('instructionTools').value.split(',').map(t => t.trim()).filter(t => t);
            const parts = document.getElementById('instructionParts').value.split(',').map(t => t.trim()).filter(t => t);
            formData.append('tools', JSON.stringify(tools));
            formData.append('parts_required', JSON.stringify(parts));
            
            // –°–æ–±–∏—Ä–∞–µ–º —à–∞–≥–∏
            const steps = [];
            const stepItems = document.querySelectorAll('.step-item');
            stepItems.forEach((item, index) => {
                const step = {
                    step_number: index + 1,
                    title: item.querySelector('.step-title').value,
                    description: item.querySelector('.step-description').value,
                    estimated_time: item.querySelector('.step-time').value,
                    image_url: null
                };
                steps.push(step);
            });
            formData.append('steps', JSON.stringify(steps));
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
            stepItems.forEach((item, index) => {
                const stepPhotos = item.querySelector('.step-photo').files;
                for (let i = 0; i < stepPhotos.length; i++) {
                    formData.append(`step_${index}_photo`, stepPhotos[i]);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã
            const mediaFiles = document.getElementById('instructionMedia').files;
            for (let i = 0; i < mediaFiles.length; i++) {
                formData.append('media', mediaFiles[i]);
            }

            try {
                const url = editingInstructionId ? `/api/admin/instructions/${editingInstructionId}` : '/api/admin/instructions';
                const method = editingInstructionId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    alert('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                    closeModal();
                    loadInstructions();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error saving instruction:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.addEventListener('DOMContentLoaded', function() {
            // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', authenticate);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            const addBtn = document.getElementById('addBtn');
            if (addBtn) {
                addBtn.addEventListener('click', showAddModal);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–≥–∞
            const addStepBtn = document.getElementById('addStepBtn');
            if (addStepBtn) {
                addStepBtn.addEventListener('click', addStep);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
            const categorySelect = document.getElementById('instructionCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', loadBrandsForAdmin);
            }
            const brandSelect = document.getElementById('instructionBrand');
            if (brandSelect) {
                brandSelect.addEventListener('change', loadModelsForAdmin);
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('instructionModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
